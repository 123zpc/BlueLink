name: Build & Release Windows (Inno EXE + MSI)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Get version
      shell: pwsh
      run: |
        $v = "${{ github.ref_name }}".TrimStart("v")
        echo "APP_VERSION=$v" >> $env:GITHUB_ENV

    - name: Map workspace to short path
      shell: pwsh
      run: |
        subst W: $env:GITHUB_WORKSPACE

    - name: Build with Maven
      shell: cmd
      run: |
        cd /d W:\
        mvn clean package -DskipTests -Dmaven.repo.local=W:\.m2

    - name: Locate runnable jar
      shell: pwsh
      run: |
        $jar = Get-ChildItem W:\target\*.jar |
          Where-Object { $_.Name -notmatch 'original|sources|javadoc' } |
          Select-Object -First 1

        if (-not $jar) { exit 1 }

        echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_ENV

    - name: Build app-image
      shell: pwsh
      run: |
        Remove-Item C:\jpt -Recurse -Force -ErrorAction SilentlyContinue
        New-Item C:\jpt -ItemType Directory | Out-Null
        Copy-Item W:\target\${{ env.JAR_NAME }} C:\jpt\

        jpackage `
          --type app-image `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor BlueLink `
          --dest W:\app-image

    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # ✅ 关键修复点：不用 PowerShell here-string
    - name: Build Inno Setup EXE
      shell: cmd
      run: |
        echo [Setup] > W:\setup.iss
        echo AppName=BlueLink >> W:\setup.iss
        echo AppVersion=%APP_VERSION% >> W:\setup.iss
        echo DefaultDirName={autopf}\BlueLink >> W:\setup.iss
        echo OutputDir=W:\release >> W:\setup.iss
        echo OutputBaseFilename=BlueLink_Setup_%APP_VERSION% >> W:\setup.iss
        echo SetupIconFile=W:\src\main\resources\app_icon.ico >> W:\setup.iss
        echo WizardStyle=modern >> W:\setup.iss
        echo Compression=lzma2 >> W:\setup.iss
        echo SolidCompression=yes >> W:\setup.iss

        echo. >> W:\setup.iss
        echo [Languages] >> W:\setup.iss
        echo Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl" >> W:\setup.iss

        echo. >> W:\setup.iss
        echo [Files] >> W:\setup.iss
        echo Source: "W:\app-image\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs >> W:\setup.iss

        echo. >> W:\setup.iss
        echo [Icons] >> W:\setup.iss
        echo Name: "{autoprograms}\BlueLink"; Filename: "{app}\BlueLink.exe" >> W:\setup.iss
        echo Name: "{autodesktop}\BlueLink"; Filename: "{app}\BlueLink.exe" >> W:\setup.iss

        echo. >> W:\setup.iss
        echo [Run] >> W:\setup.iss
        echo Filename: "{app}\BlueLink.exe"; Flags: nowait postinstall >> W:\setup.iss

        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" W:\setup.iss

    - name: Build MSI
      shell: pwsh
      run: |
        jpackage `
          --type msi `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor BlueLink `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser `
          --dest W:\release

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/*.exe
          release/*.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
