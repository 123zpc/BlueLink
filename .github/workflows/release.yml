name: Build Windows EXE + MSI

on:
  push:
    tags:
      - "v*"

jobs:
  windows:
    runs-on: windows-latest

    env:
      APP_NAME: BlueLink

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 下载简体中文语言文件
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/kira-96/Inno-Setup-Chinese-Simplified-Translation/main/ChineseSimplified.isl" -OutFile "ChineseSimplified.isl"
        shell: pwsh

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ================= Build JAR =================
      - name: Build with Maven
        run: mvn -B clean package -DskipTests
        shell: powershell

      - name: Prepare directories
        run: |
          mkdir jpt
          mkdir release
        shell: powershell

      # ================= Find JAR =================
      - name: Locate JAR
        id: jar
        run: |
          $jar = Get-ChildItem target -Filter "*.jar" | Where-Object { $_.Name -notlike "*sources*" -and $_.Name -notlike "*javadoc*" } | Select-Object -First 1
          if (-not $jar) { throw "No jar found in target directory" }
          echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_ENV
        shell: powershell

      - name: Copy JAR to jpackage input
        run: copy target\$env:JAR_NAME jpt\
        shell: powershell

      # ================= MSI (jpackage) =================
      - name: Build MSI with jpackage
        run: |
          jpackage `
            --type msi `
            --name $env:APP_NAME `
            --input jpt `
            --main-jar $env:JAR_NAME `
            --main-class com.bluelink.Main `
            --icon src\main\resources\app_icon.ico `
            --vendor BlueLink `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser `
            --dest release
        shell: pwsh

      # ================= Install Inno Setup =================
      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: powershell

      # ================= Generate Inno Setup script =================
      - name: Generate Inno Setup script
        run: |
          $version = "${{ github.ref_name }}" -replace '^v',''
          @"
          [Setup]
          AppName=BlueLink
          AppVersion=$version
          DefaultDirName={pf}\BlueLink
          DefaultGroupName=BlueLink
          OutputDir=release
          OutputBaseFilename=BlueLink-Setup-$version
          Compression=lzma
          SolidCompression=yes
          SetupIconFile=src\main\resources\app_icon.ico

          [Languages]
          Name: "chinesesimp"; MessagesFile: "ChineseSimplified.isl"

          [Files]
          Source: "release\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\BlueLink"; Filename: "{app}\BlueLink.exe"

          [Run]
          Filename: "{app}\BlueLink.exe"; Description: "启动 BlueLink"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -Encoding ASCII setup.iss
        shell: powershell

      # ================= Build EXE =================
      - name: Build EXE with Inno Setup
        run: iscc setup.iss
        shell: powershell

      # ================= Upload Artifacts =================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BlueLink-Windows
          path: release