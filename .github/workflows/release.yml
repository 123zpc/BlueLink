name: Build and Release Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code to short relative path
      uses: actions/checkout@v4
      with:
        path: src

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      run: mvn clean package -DskipTests
      working-directory: src

    - name: Get Version
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        echo "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
      working-directory: src

    - name: Prepare short temp directory for jpackage
      shell: pwsh
      run: |
        $tempDir = "C:\jpt"
        Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
      working-directory: src

    - name: Create App Image (Base for both MSI and EXE)
      run: |
        jpackage `
          --name BlueLink `
          --input target `
          --main-jar BlueLink-1.0-SNAPSHOT.jar `
          --main-class com.bluelink.Main `
          --icon src/main/resources/app_icon.ico `
          --type app-image `
          --app-version ${{ env.APP_VERSION }} `
          --dest target/image `
          --temp C:\jpt
      working-directory: src

    - name: Create MSI from Image
      run: |
        jpackage `
          --name BlueLink `
          --app-image target/image/BlueLink `
          --type msi `
          --win-dir-chooser `
          --win-menu `
          --win-shortcut `
          --app-version ${{ env.APP_VERSION }} `
          --dest release
      working-directory: src

    - name: Install Inno Setup
      run: choco install innosetup --no-progress
      working-directory: src

    - name: Generate and Build EXE with Inno Setup
      shell: pwsh
      working-directory: src
      run: |
        $issContent = @"
        [Setup]
        AppId={{D3776518-2023-4422-A938-BLUELINK123}
        AppName=BlueLink
        AppVersion=${{ env.APP_VERSION }}
        AppPublisher=BlueLink Inc.
        DefaultDirName={autopf}\BlueLink
        LanguageDetectionMethod=uilanguage
        ShowLanguageDialog=yes
        OutputDir=release
        OutputBaseFilename=BlueLink_Setup_${{ env.APP_VERSION }}
        SetupIconFile=src\main\resources\app_icon.ico
        Compression=lzma2/fast
        SolidCompression=yes
        WizardStyle=modern

        [Languages]
        Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "target\image\BlueLink\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{autoprograms}\BlueLink"; Filename: "{app}\BlueLink.exe"
        Name: "{autodesktop}\BlueLink"; Filename: "{app}\BlueLink.exe"; Tasks: desktopicon

        [Run]
        Filename: "{app}\BlueLink.exe"; Description: "{cm:LaunchProgram,BlueLink}"; Flags: nowait postinstall skipifsilent
        "@

        $issContent | Out-File -FilePath setup.iss -Encoding UTF8
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          src/release/*.msi
          src/release/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up jpackage temp directory
      if: always()
      shell: pwsh
      run: Remove-Item -Path "C:\jpt" -Recurse -Force -ErrorAction SilentlyContinue