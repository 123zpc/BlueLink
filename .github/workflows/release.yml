name: Build and Release Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 设置 JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Maven 构建 (生成 jar)
    - name: Build with Maven
      run: mvn clean package -DskipTests

    # 4. 获取版本号 (例如 v1.0.0 -> 1.0.0)
    - name: Get Version
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        echo "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
        echo "Detected Version: $version"

    # ========================================================
    # 任务 A: 生成 MSI 安装包 (jpackage 原生)
    # ========================================================
    - name: Create MSI Installer
      run: |
        jpackage `
          --name BlueLink `
          --input target `
          --main-jar BlueLink-1.0-SNAPSHOT.jar `
          --main-class com.bluelink.Main `
          --icon src/main/resources/app_icon.ico `
          --type msi `
          --win-dir-chooser `
          --win-menu `
          --win-shortcut `
          --app-version ${{ env.APP_VERSION }} `
          --dest release

    # ========================================================
    # 任务 B: 生成 EXE 中文安装包 (jpackage + Inno Setup)
    # ========================================================
    
    # B1. 生成 App Image (生成带有图标的程序文件夹)
    - name: Create App Image (for Inno Setup)
      run: |
        jpackage `
          --name BlueLink `
          --input target `
          --main-jar BlueLink-1.0-SNAPSHOT.jar `
          --main-class com.bluelink.Main `
          --icon src/main/resources/app_icon.ico `
          --type app-image `
          --app-version ${{ env.APP_VERSION }} `
          --dest target/image

    # B2. 安装 Inno Setup 编译器
    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # B3. 动态生成配置脚本并极速编译
    - name: Generate and Build EXE
      shell: pwsh
      run: |
        # 动态创建 Inno Setup 脚本
        $issContent = @"
        [Setup]
        AppId={{D3776518-2023-4422-A938-BLUELINK123}
        AppName=BlueLink
        AppVersion=${{ env.APP_VERSION }}
        AppPublisher=BlueLink Inc.
        DefaultDirName={autopf}\BlueLink
        LanguageDetectionMethod=uilanguage
        ShowLanguageDialog=yes
        OutputDir=release
        OutputBaseFilename=BlueLink_Setup_${{ env.APP_VERSION }}
        ; 这里确保安装包文件本身显示你的图标
        SetupIconFile=src\main\resources\app_icon.ico
        
        ; === 速度优化配置 ===
        ; 使用 lzma2 多线程压缩，级别设为 fast
        Compression=lzma2/fast
        SolidCompression=yes
        ; ===================
        
        WizardStyle=modern

        [Languages]
        Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        ; 抓取步骤 B1 生成的文件
        Source: "target\image\BlueLink\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{autoprograms}\BlueLink"; Filename: "{app}\BlueLink.exe"
        Name: "{autodesktop}\BlueLink"; Filename: "{app}\BlueLink.exe"; Tasks: desktopicon

        [Run]
        Filename: "{app}\BlueLink.exe"; Description: "{cm:LaunchProgram,BlueLink}"; Flags: nowait postinstall skipifsilent
        "@

        # 写入临时文件
        $issContent | Out-File -FilePath setup.iss -Encoding UTF8

        # 执行编译
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    # ========================================================
    # 上传发布结果
    # ========================================================
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/*.msi
          release/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}