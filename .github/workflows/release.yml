name: Build & Release Windows (Inno EXE + MSI)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # 1Ô∏è‚É£ Checkout
    - name: Checkout
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3Ô∏è‚É£ ÁâàÊú¨Âè∑ v1.0.0 -> 1.0.0
    - name: Get version
      shell: pwsh
      run: |
        $v = "${{ github.ref_name }}".TrimStart("v")
        echo "APP_VERSION=$v" >> $env:GITHUB_ENV

    # 4Ô∏è‚É£ Êò†Â∞ÑÁü≠Ë∑ØÂæÑÔºàÈò≤ 32KÔºâ
    - name: Map workspace to short path
      shell: pwsh
      run: |
        subst W: $env:GITHUB_WORKSPACE

    # 5Ô∏è‚É£ Maven ÊûÑÂª∫ÔºàÁü≠Ë∑ØÂæÑ‰ªìÂ∫ìÔºâ
    - name: Build with Maven
      shell: cmd
      run: |
        cd /d W:\
        mvn clean package -DskipTests -Dmaven.repo.local=W:\.m2

    # 6Ô∏è‚É£ ÊâæÂà∞ÁúüÊ≠£ÁöÑ jar
    - name: Locate runnable jar
      shell: pwsh
      run: |
        $jar = Get-ChildItem W:\target\*.jar |
               Where-Object { $_.Name -notmatch 'original|sources|javadoc' } |
               Select-Object -First 1

        if (-not $jar) {
          Write-Error "No runnable jar found"
          exit 1
        }

        echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_ENV

    # 7Ô∏è‚É£ ÁîüÊàê app-imageÔºàÁªô Inno Áî®Ôºâ
    - name: Build app-image
      shell: pwsh
      run: |
        Remove-Item C:\jpt -Recurse -Force -ErrorAction SilentlyContinue
        New-Item C:\jpt -ItemType Directory | Out-Null
        Copy-Item W:\target\${{ env.JAR_NAME }} C:\jpt\

        jpackage `
          --type app-image `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor "BlueLink" `
          --dest W:\app-image

    # 8Ô∏è‚É£ ÂÆâË£Ö Inno Setup
    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # 9Ô∏è‚É£ ÁîüÊàê Inno EXEÔºà‰∏≠Êñá + ÂõæÊ†áÔºâ
    - name: Build Inno Setup EXE
      shell: pwsh
      run: |
        $iss = @"
[Setup]
AppName=BlueLink
AppVersion=${{ env.APP_VERSION }}
DefaultDirName={autopf}\BlueLink
OutputDir=W:\release
OutputBaseFilename=BlueLink_Setup_${{ env.APP_VERSION }}
SetupIconFile=W:\src\main\resources\app_icon.ico
WizardStyle=modern
Compression=lzma2
SolidCompression=yes

[Languages]
Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

[Files]
Source: "W:\app-image\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

[Icons]
Name: "{autoprograms}\BlueLink"; Filename: "{app}\BlueLink.exe"
Name: "{autodesktop}\BlueLink"; Filename: "{app}\BlueLink.exe"

[Run]
Filename: "{app}\BlueLink.exe"; Flags: nowait postinstall
"@

        $iss | Out-File W:\setup.iss -Encoding UTF8
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" W:\setup.iss

    # üîü ÊûÑÂª∫ MSIÔºà‰ºÅ‰∏öÁâàÔºâ
    - name: Build MSI
      shell: pwsh
      run: |
        jpackage `
          --type msi `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor "BlueLink" `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser `
          --dest W:\release

    # 1Ô∏è‚É£1Ô∏è‚É£ ÂèëÂ∏É Release
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/*.exe
          release/*.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
