name: Build and Release Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # ------------------------------------------------------------
    # 1. Checkout（必须在 workspace 内）
    # ------------------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # 2. 将 workspace 映射为短盘符 W:
    # ------------------------------------------------------------
    - name: Map workspace to short drive
      shell: pwsh
      run: |
        subst W: $env:GITHUB_WORKSPACE
        "WORK_DRIVE=W:" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

    # ------------------------------------------------------------
    # 3. 安装 JDK 17
    # ------------------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # ------------------------------------------------------------
    # 4. Maven 构建
    # ------------------------------------------------------------
    - name: Build with Maven
      working-directory: ${{ env.WORK_DRIVE }}
      run: mvn clean package -DskipTests

    # ------------------------------------------------------------
    # 5. 解析 tag 版本号
    # ------------------------------------------------------------
    - name: Get Version
      shell: pwsh
      working-directory: ${{ env.WORK_DRIVE }}
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

    # ------------------------------------------------------------
    # 6. 构建超短路径 Java Runtime（关键！）
    # ------------------------------------------------------------
    - name: Build custom runtime with jlink
      shell: pwsh
      run: |
        $rt = "C:\rt"
        Remove-Item -Recurse -Force $rt -ErrorAction SilentlyContinue

        jlink `
          --module-path "$env:JAVA_HOME\jmods" `
          --add-modules java.base,java.desktop,java.logging `
          --strip-debug `
          --no-man-pages `
          --no-header-files `
          --compress=2 `
          --output $rt

    # ------------------------------------------------------------
    # 7. jpackage 临时目录（短）
    # ------------------------------------------------------------
    - name: Prepare jpackage temp
      shell: pwsh
      run: |
        $tempDir = "C:\jpt"
        Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

    # ------------------------------------------------------------
    # 8. 生成 App Image（使用自定义 runtime）
    # ------------------------------------------------------------
    - name: Create App Image
      shell: pwsh
      working-directory: ${{ env.WORK_DRIVE }}
      run: |
        jpackage `
          --name BlueLink `
          --input target `
          --main-jar BlueLink-1.0-SNAPSHOT.jar `
          --main-class com.bluelink.Main `
          --icon src/main/resources/app_icon.ico `
          --type app-image `
          --runtime-image C:\rt `
          --app-version ${{ env.APP_VERSION }} `
          --dest target/image `
          --temp C:\jpt

    # ------------------------------------------------------------
    # 9. 生成 MSI（记得再指定 icon）
    # ------------------------------------------------------------
    - name: Create MSI
      shell: pwsh
      working-directory: ${{ env.WORK_DRIVE }}
      run: |
        jpackage `
          --name BlueLink `
          --app-image target/image/BlueLink `
          --type msi `
          --icon src/main/resources/app_icon.ico `
          --win-dir-chooser `
          --win-menu `
          --win-shortcut `
          --app-version ${{ env.APP_VERSION }} `
          --dest release

    # ------------------------------------------------------------
    # 10. 安装 Inno Setup
    # ------------------------------------------------------------
    - name: Install Inno Setup
      run: choco install innosetup --no-progress

    # ------------------------------------------------------------
    # 11. 构建中文 EXE 安装包（Inno Setup）
    # ------------------------------------------------------------
    - name: Build EXE with Inno Setup
      shell: pwsh
      working-directory: ${{ env.WORK_DRIVE }}
      run: |
        $iss = @"
        [Setup]
        AppId={{D3776518-2023-4422-A938-BLUELINK123}
        AppName=BlueLink
        AppVersion=${{ env.APP_VERSION }}
        AppPublisher=BlueLink Inc.
        DefaultDirName={autopf}\BlueLink
        OutputDir=release
        OutputBaseFilename=BlueLink_Setup_${{ env.APP_VERSION }}
        SetupIconFile=src\main\resources\app_icon.ico
        Compression=lzma2/fast
        SolidCompression=yes
        WizardStyle=modern

        [Languages]
        Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; Flags: unchecked

        [Files]
        Source: "target\image\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

        [Icons]
        Name: "{autoprograms}\BlueLink"; Filename: "{app}\BlueLink.exe"
        Name: "{autodesktop}\BlueLink"; Filename: "{app}\BlueLink.exe"; Tasks: desktopicon

        [Run]
        Filename: "{app}\BlueLink.exe"; Flags: nowait postinstall skipifsilent
        "@

        $iss | Out-File setup.iss -Encoding UTF8
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    # ------------------------------------------------------------
    # 12. 上传 Release 产物
    # ------------------------------------------------------------
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          W:\release\*.msi
          W:\release\*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ------------------------------------------------------------
    # 13. 清理
    # ------------------------------------------------------------
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        subst W: /D
        Remove-Item -Path "C:\jpt" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\rt" -Recurse -Force -ErrorAction SilentlyContinue
