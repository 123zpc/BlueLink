name: Build & Release Windows (EXE + MSI)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # 1️⃣ Checkout
    - name: Checkout
      uses: actions/checkout@v4

    # 2️⃣ Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3️⃣ 解析版本号 v1.0.0 -> 1.0.0
    - name: Get version
      shell: pwsh
      run: |
        $v = "${{ github.ref_name }}".TrimStart("v")
        echo "APP_VERSION=$v" >> $env:GITHUB_ENV

    # 4️⃣ 映射短路径（防 32K 路径）
    - name: Map workspace to short path
      shell: pwsh
      run: |
        subst W: $env:GITHUB_WORKSPACE

    # 5️⃣ Maven 构建（本地仓库也用短路径）
    - name: Build with Maven
      shell: cmd
      run: |
        cd /d W:\
        mvn clean package -DskipTests -Dmaven.repo.local=W:\.m2

    # 6️⃣ 自动找到真正的 jar（不猜名字）
    - name: Prepare jpackage input
      shell: pwsh
      run: |
        Remove-Item C:\jpt -Recurse -Force -ErrorAction SilentlyContinue
        New-Item C:\jpt -ItemType Directory | Out-Null

        $jar = Get-ChildItem W:\target\*.jar |
               Where-Object { $_.Name -notmatch 'original|sources|javadoc' } |
               Select-Object -First 1

        if (-not $jar) {
          Write-Error "No runnable jar found in target"
          exit 1
        }

        Copy-Item $jar.FullName C:\jpt\
        echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_ENV

    # 7️⃣ 构建 EXE（中文 + 图标）
    - name: Build EXE
      shell: pwsh
      run: |
        jpackage `
          --type exe `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor "BlueLink" `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser `
          --dest W:\release

    # 8️⃣ 构建 MSI（中文 + 图标）
    - name: Build MSI
      shell: pwsh
      run: |
        jpackage `
          --type msi `
          --name BlueLink `
          --input C:\jpt `
          --main-jar ${{ env.JAR_NAME }} `
          --main-class com.bluelink.Main `
          --icon W:\src\main\resources\app_icon.ico `
          --app-version ${{ env.APP_VERSION }} `
          --vendor "BlueLink" `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser `
          --dest W:\release

    # 9️⃣ 发布到 GitHub Release
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/*.exe
          release/*.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
