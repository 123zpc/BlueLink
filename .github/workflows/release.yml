name: Build and Release Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # ------------------------------------------------------------
    # 1. Checkout
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    # ------------------------------------------------------------
    # 2. JDK 17
    # ------------------------------------------------------------
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # ------------------------------------------------------------
    # 3. Maven Build
    # ------------------------------------------------------------
    - name: Build with Maven
      run: mvn -B clean package -DskipTests

    # ------------------------------------------------------------
    # 4. 解析版本号
    # ------------------------------------------------------------
    - name: Get Version
      shell: pwsh
      run: |
        $v = "${{ github.ref_name }}".TrimStart('v')
        "APP_VERSION=$v" | Out-File $env:GITHUB_ENV -Encoding utf8

    # ------------------------------------------------------------
    # 5. 准备“极短 & 干净”的 jpackage 输入目录（核心）
    # ------------------------------------------------------------
    - name: Prepare jpackage input
      shell: pwsh
      run: |
        $base = "C:\pkg"
        $app  = "$base\app"
        $out  = "$base\out"
        $tmp  = "$base\tmp"

        Remove-Item $base -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory $app,$out,$tmp | Out-Null

        Copy-Item `
          target\BlueLink-1.0-SNAPSHOT.jar `
          "$app\BlueLink.jar"

    # ------------------------------------------------------------
    # 6. 构建极短 runtime
    # ------------------------------------------------------------
    - name: Build runtime
      shell: pwsh
      run: |
        jlink `
          --module-path "$env:JAVA_HOME\jmods" `
          --add-modules java.base,java.desktop,java.logging `
          --strip-debug `
          --no-man-pages `
          --no-header-files `
          --compress=2 `
          --output C:\pkg\rt

    # ------------------------------------------------------------
    # 7. 生成 App Image（绝不会再爆）
    # ------------------------------------------------------------
    - name: Create App Image
      shell: pwsh
      run: |
        jpackage `
          --name BlueLink `
          --input C:\pkg\app `
          --main-jar BlueLink.jar `
          --main-class com.bluelink.Main `
          --icon src\main\resources\app_icon.ico `
          --type app-image `
          --runtime-image C:\pkg\rt `
          --app-version ${{ env.APP_VERSION }} `
          --dest C:\pkg\out `
          --temp C:\pkg\tmp

    # ------------------------------------------------------------
    # 8. 生成 MSI（图标是你的）
    # ------------------------------------------------------------
    - name: Create MSI
      shell: pwsh
      run: |
        jpackage `
          --name BlueLink `
          --app-image C:\pkg\out\BlueLink `
          --type msi `
          --icon src\main\resources\app_icon.ico `
          --win-menu `
          --win-shortcut `
          --app-version ${{ env.APP_VERSION }} `
          --dest C:\pkg\out

    # ------------------------------------------------------------
    # 9. 上传 Release
    # ------------------------------------------------------------
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          C:\pkg\out\*.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
