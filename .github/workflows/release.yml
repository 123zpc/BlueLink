name: Build Windows EXE + MSI

# ================= 权限设置 =================
# 必须给予写权限，否则最后的 Release 步骤会报 403 错误
permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  windows:
    runs-on: windows-latest

    env:
      APP_NAME: BlueLink

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 下载简体中文语言文件
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/kira-96/Inno-Setup-Chinese-Simplified-Translation/main/ChineseSimplified.isl" -OutFile "ChineseSimplified.isl"
        shell: pwsh

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ================= Build JAR =================
      - name: Build with Maven
        run: mvn -B clean package -DskipTests
        shell: powershell

      - name: Prepare directories
        run: |
          mkdir jpt
          mkdir release
        shell: powershell

      # ================= Find JAR =================
      - name: Locate JAR
        id: jar
        run: |
          $jar = Get-ChildItem target -Filter "*.jar" | Where-Object { $_.Name -notlike "*sources*" -and $_.Name -notlike "*javadoc*" } | Select-Object -First 1
          if (-not $jar) { throw "No jar found in target directory" }
          echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_ENV
        shell: powershell

      - name: Copy JAR to jpackage input
        run: copy target\$env:JAR_NAME jpt\
        shell: powershell

      # ================= 1. Build App Image (用于生成 EXE 的文件夹) =================
      - name: Build App Image for Inno Setup
        run: |
          jpackage `
            --type app-image `
            --name $env:APP_NAME `
            --input jpt `
            --main-jar $env:JAR_NAME `
            --main-class com.bluelink.Main `
            --icon src\main\resources\app_icon.ico `
            --vendor BlueLink `
            --dest release
        shell: pwsh

      # ================= 2. Build MSI (独立安装包) =================
      - name: Build MSI Installer
        run: |
          jpackage `
            --type msi `
            --name $env:APP_NAME `
            --input jpt `
            --main-jar $env:JAR_NAME `
            --main-class com.bluelink.Main `
            --icon src\main\resources\app_icon.ico `
            --vendor BlueLink `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser `
            --dest release
        shell: pwsh

      # ================= Install Inno Setup =================
      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: powershell

      # ================= Generate Inno Setup script =================
      - name: Generate Inno Setup script
        run: |
          $version = "${{ github.ref_name }}" -replace '^v',''
          @"
          [Setup]
          AppName=BlueLink
          AppVersion=$version
          DefaultDirName={pf}\BlueLink
          DefaultGroupName=BlueLink
          OutputDir=release
          OutputBaseFilename=BlueLink-Setup-$version
          Compression=lzma
          SolidCompression=yes
          SetupIconFile=src\main\resources\app_icon.ico
          UninstallDisplayIcon={app}\BlueLink.exe

          [Languages]
          Name: "chinesesimp"; MessagesFile: "ChineseSimplified.isl"

          [Files]
          ; 使用 app-image 步骤生成的文件夹
          Source: "release\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\BlueLink"; Filename: "{app}\BlueLink.exe"
          Name: "{commondesktop}\BlueLink"; Filename: "{app}\BlueLink.exe"

          [Run]
          Filename: "{app}\BlueLink.exe"; Description: "启动 BlueLink"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -Encoding UTF8 setup.iss
        shell: powershell

      # ================= Build EXE =================
      - name: Build EXE with Inno Setup
        run: iscc setup.iss
        shell: powershell

      # ================= Upload Artifacts (EXE + MSI) =================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BlueLink-Windows-Installers
          path: |
            release/*.exe
            release/*.msi

      # ================= Release (EXE + MSI) =================
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release/*.exe
            release/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}