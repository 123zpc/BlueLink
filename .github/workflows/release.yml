name: Build Windows EXE + MSI

on:
  push:
    tags:
      - "v*"

jobs:
  windows:
    runs-on: windows-latest

    env:
      APP_NAME: BlueLink
      APP_VERSION: 1.0.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Prepare directories
        run: |
          mkdir jpt
          mkdir release
        shell: powershell

      - name: Copy jar to jpackage input
        run: |
          copy target\BlueLink-${{ env.APP_VERSION }}.jar jpt\
        shell: powershell

      # ================= MSI (jpackage) =================
      - name: Build MSI with jpackage
        run: |
          jpackage `
            --type msi `
            --name $env:APP_NAME `
            --input jpt `
            --main-jar BlueLink-$env:APP_VERSION.jar `
            --main-class com.bluelink.Main `
            --icon src\main\resources\app_icon.ico `
            --app-version $env:APP_VERSION `
            --vendor BlueLink `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser `
            --dest release
        shell: pwsh

      # ================= Install Inno Setup =================
      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: powershell

      # ================= Generate Inno Script =================
      - name: Generate Inno Setup script
        run: |
          @"
          [Setup]
          AppName=BlueLink
          AppVersion=${{ env.APP_VERSION }}
          DefaultDirName={pf}\BlueLink
          DefaultGroupName=BlueLink
          OutputDir=release
          OutputBaseFilename=BlueLink-${{ env.APP_VERSION }}-Setup
          Compression=lzma
          SolidCompression=yes
          SetupIconFile=src\main\resources\app_icon.ico

          [Languages]
          Name: "chinesesimp"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

          [Files]
          Source: "release\BlueLink\*"; DestDir: "{app}"; Flags: recursesubdirs

          [Icons]
          Name: "{group}\BlueLink"; Filename: "{app}\BlueLink.exe"
          "@ | Out-File -Encoding ASCII setup.iss
        shell: powershell

      # ================= Build EXE =================
      - name: Build EXE with Inno Setup
        run: iscc setup.iss
        shell: powershell

      # ================= Upload =================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BlueLink-Windows
          path: release
